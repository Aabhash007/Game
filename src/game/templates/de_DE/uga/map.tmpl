{#
/* improvement.tmpl -
 * Copyright (c) 2003  OGP Team
 * Copyright (c) 2011 Sascha Lange <salange@uos.de>, David Unger
 *
 * This program is free software; you can redistribute it and/or
 * modify it under the terms of the GNU General Public License as
 * published by the Free Software Foundation; either version 2 of
 * the License, or (at your option) any later version. 
 */
#}

{% extends "base.tmpl" %}
{% block title %}Karte{% endblock %}
{% block content %}

<div class="notice" id="message-view" {% if not message %}style="display: none;"{% endif %}>{{ message }}</div>

<div class="box">
 <div class="boxheader">&nbsp;</div>
  <div class="box-content inner success">
   <table class="nohover" style="width: 100%;">
    <tr>    
      <td style="width: 30%; text-align: left;">
        <form id="searchCoords" method="post" action="main.php">
          <p>(X/Y):
          <input type="text" name="xCoord" size="4" maxlength="4" />
          <input type="text" name="yCoord" size="4" maxlength="4" />
          <input type="hidden" name="modus" value="{{modus}}" />
          <input type="hidden" name="caveID" value="{{caveID}}" />
          <input type="submit" value="go" /></p>
        </form>
      </td>

      <td style="text-align: center;">
        <form id="searchID" method="post" action="main.php">
          <p><a href="?modus=CaveBookmarks&amp;task=Show">H&ouml;hlenliste:</a>
          <select name="targetCaveID" id="targetCaveID">
            <option value="-1">Bitte w&auml;hlen</option>
              {% for bookmark in caveBookmarks %}
                <option value="{{ bookmark.caveID }}">{{ bookmark.name }} ({{ bookmark.xCoord }}|{{ bookmark.yCoord }})</option>
              {% endfor  %}
          </select>
          <input type="hidden" name="modus" value="map" /></p>
        </form>
      </td>
      
      <td style="width: 30%; text-align: right;">
        <form id="searchName" method="post" action="main.php">
          <p>Name:
          <input type="text" name="caveName" size="16" maxlength="50" />
          <input type="hidden" name="modus" value="{{modus}}" />
          <input type="hidden" name="caveID" value="{{caveID}}" />
          <input type="submit" value="go" /></p>
        </form>
      </td>
      
    </tr>
   </table>
  </div>
</div>



<table id="two-column-layout-table" class="nohover" style="vertical-align:top; width: 100%">
<tr>
<td>

<div class="box">
  <div class="boxheader">&nbsp;</div>
  <div class="box-content inner success" id="map-view">
  </div>
</div>

</td>
<td style="vertical-align:top; width:152px">
  
  <div class="box">
    <div class="boxheader">&nbsp;</div>

      <table class="nohover" style="width:140px;padding: 0;">
        <tr>          
          <td> <a class="arrow" id="NW" href="./main.php?caveID={caveID}&amp;modus={modus}&amp;xCoord={x}&amp;yCoord={y}"><img src="{{ gfx }}/de_DE/t_uga/map/NW.png" style="border:none;width:40px;hight:40px;" alt="nordwest" /></a>
          </td>
          <td> <a class="arrow" id="N" href="./main.php?caveID={caveID}&amp;modus={modus}&amp;xCoord={x}&amp;yCoord={y}"><img src="{{ gfx }}/de_DE/t_uga/map/N.png"  style="border:none;width:40px;hight:40px;" alt="nord" /></a>
          </td>
          <td> <a class="arrow" id="NE" href="./main.php?caveID={caveID}&amp;modus={modus}&amp;xCoord={x}&amp;yCoord={y}"><img src="{{ gfx }}/de_DE/t_uga/map/NO.png" style="border:none;width:40px;hight:40px;" alt="nordost" /></a>
          </td>
         </tr>
         <tr>
          <td> <a class="arrow" id="W" href="./main.php?caveID={caveID}&amp;modus={modus}&amp;xCoord={x}&amp;yCoord={y}"><img src="{{ gfx }}/de_DE/t_uga/map/W.png"  style="border:none;width:40px;hight:40px;" alt="west" /></a>
          </td>
          <td>&nbsp;</td>
          <td> <a class="arrow" id="E" href="./main.php?caveID={caveID}&amp;modus={modus}&amp;xCoord={x}&amp;yCoord={y}"><img src="{{ gfx }}/de_DE/t_uga/map/O.png"  style="border:none;width:40px;hight:40px;" alt="ost" /></a>
          </td>
         </tr>
         <tr>
          <td> <a class="arrow" id="SW" href="./main.php?caveID={caveID}&amp;modus={modus}&amp;xCoord={x}&amp;yCoord={y}"><img src="{{ gfx }}/de_DE/t_uga/map/SW.png" style="border:none;width:40px;hight:40px;" alt="s&uuml;dwest" /></a>
          </td>
          <td> <a class="arrow" id="S" href="./main.php?caveID={caveID}&amp;modus={modus}&amp;xCoord={x}&amp;yCoord={y}"><img src="{{ gfx }}/de_DE/t_uga/map/S.png"  style="border:none;width:40px;hight:40px;" alt="s&uuml;d" /></a>
          </td>
          <td> <a class="arrow" id="SE" href="./main.php?caveID={caveID}&amp;modus={modus}&amp;xCoord={x}&amp;yCoord={y}"><img src="{{ gfx }}/de_DE/t_uga/map/SO.png" style="border:none;width:40px;hight:40px;" alt="s&uuml;dost" /></a>
          </td>         
        </tr>
      </table>
      
      
         {% if minimap %} 
         <div class="box-content inner success" id="minimap-view">
          <form action="main.php" method="post" id="minimapform">
           <p><input name="minimap" type="image" style="width: {{ minimap.width}}px; height: {{minimap.height}}px; border: thin groove #009900; cursor: crosshair;" src="{{minimap.file}}" />
             <input type="hidden" name="scaling" value="{{minimap.scaling}}" />
             <input type="hidden" name="modus"  value="{{minimap.modus}}" />
             <input type="hidden" name="caveID" value="{{minimap.caveID}}" />
           </p>
          </form>
          </div>
         {% endif %}
  </div>
         
</td>
</tr>
</table>

<script>
  $(document).ready(function() {
    
    function displayMessage()
    {
      var message = $('#message');
      
      if (message.length == 0) return ;
      
      $('#message-view')
      .html(message.html())
      .slideDown();
      
      message.remove();
    }
    
    function hideMessage()
    {
      $('#message-view')
      .slideUp();
    }
    
    function loadMap(query)
    {
      $("#map-view").load(query, function() {
        if ($('#map-view #message').length > 0) {
          displayMessage();
        }
        else {
          hideMessage();
        }
      });
    }
    
    $('#searchCoords').submit(function () {
      var xCoord = $(this).find(':text[name=xCoord]').val();
      var yCoord = $(this).find(':text[name=yCoord]').val();
      
      if (xCoord === '' || yCoord ==='') return false;
      
      loadMap("./main.php?caveID={{caveID}}&modus={{ mapRegionLink }}&xCoord="+xCoord+"&yCoord="+yCoord);
      return false;
    });
    
    $('#searchName').submit(function () {
      var caveName = $(this).find(':text[name=caveName]').val();
      
      if (caveName === '') return false;
      
      loadMap("./main.php?caveID={{caveID}}&modus={{ mapRegionLink }}&caveName="+caveName);
      return false;
    });
    
    $('#searchID #targetCaveID').change(function () {
      var targetCaveID = $(this).find(':text[name=targetCaveID]').val();
      if (targetCaveID < 0) return false;
      loadMap("./main.php?caveID={{caveID}}&modus={{ mapRegionLink }}&targetCaveID="+targetCaveID);
      return false;
    });
  
    // store the direction to move the map with each arrow
    $('#NW').data('dx', -1).data('dy', -1); 
    $('#N').data('dx', 0).data('dy', -1); 
    $('#NE').data('dx', 1).data('dy', -1); 
    $('#E').data('dx', 1).data('dy', 0); 
    $('#SE').data('dx', 1).data('dy', 1); 
    $('#S').data('dx', 0).data('dy', 1); 
    $('#SW').data('dx', -1).data('dy', 1); 
    $('#W').data('dx', -1).data('dy', 0); 
    
    $('a.arrow').click(function (event) {
      event.preventDefault();

      var xCoord = $('#map-centerX').html();
      var yCoord = $('#map-centerY').html();
      
      var dx = $(this).data('dx');
      var dy = $(this).data('dy');
      
      if (xCoord === '' || yCoord === '' || (dx == 0 && dy == 0)) {
        return false;
      }

      xCoord = parseInt(xCoord) + dx;
      yCoord = parseInt(yCoord) + dy;
            
      loadMap("./main.php?caveID={{caveID}}&modus={{ mapRegionLink }}&xCoord="+xCoord+"&yCoord="+yCoord);

    });
    
    $("#map-view")
    .html("Loading...");
    loadMap("./main.php?caveID={{caveID}}&modus={{ mapRegionLink }}&xCoord={{xCoord}}&yCoord={{yCoord}}");
  })
</script>

{% endblock %}